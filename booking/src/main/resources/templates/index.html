<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂房系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .accommodation-card {
            transition: transform 0.2s;
        }
        .accommodation-card:hover {
            transform: translateY(-5px);
        }
        .booking-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">訂房系統</a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">歡迎, <span id="username"></span></span>
            <form th:action="@{/logout}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-outline-light btn-sm">登出</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- 搜尋區域 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>住宿搜尋</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="locationSearch" class="form-label">地點搜尋</label>
                        <input type="text" class="form-control" id="locationSearch" placeholder="輸入地點 (例: 台北)">
                        <button class="btn btn-primary mt-2" onclick="searchByLocation()">搜尋</button>
                        <button class="btn btn-secondary mt-2" onclick="loadAllAccommodations()">顯示全部</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>日期查詢</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="checkIn" class="form-label">入住日期</label>
                            <input type="date" class="form-control" id="checkIn">
                        </div>
                        <div class="col-md-6">
                            <label for="checkOut" class="form-label">退房日期</label>
                            <input type="date" class="form-control" id="checkOut">
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" onclick="searchAvailable()">查詢可用住宿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 住宿列表 -->
    <div class="row">
        <div class="col-12">
            <h3>住宿列表</h3>
            <div id="accommodations" class="row">
                <!-- 住宿卡片將動態插入這裡 -->
            </div>
        </div>
    </div>

    <!-- 我的訂房記錄 -->
    <div class="booking-section mt-4">
        <h3>我的訂房記錄</h3>
        <button class="btn btn-info mb-3" onclick="loadMyBookings()">重新載入訂房記錄</button>
        <div id="myBookings">
            <!-- 訂房記錄將動態插入這裡 -->
        </div>
    </div>
</div>

<!-- 訂房模態框 -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認訂房</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bookingDetails"></div>
                <div class="mt-3">
                    <label for="modalCheckIn" class="form-label">入住日期</label>
                    <input type="date" class="form-control" id="modalCheckIn">
                </div>
                <div class="mt-3">
                    <label for="modalCheckOut" class="form-label">退房日期</label>
                    <input type="date" class="form-control" id="modalCheckOut">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmBooking()">確認訂房</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let selectedAccommodationId = null;
    let bookingModal;

    // 頁面載入時執行
    document.addEventListener('DOMContentLoaded', function() {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        loadAllAccommodations();
        loadMyBookings();
    });

    // 載入所有住宿
    function loadAllAccommodations() {
        fetch('/api/accommodations')
            .then(response => response.json())
            .then(data => displayAccommodations(data))
            .catch(error => {
                console.error('Error:', error);
                showAlert('載入住宿失敗', 'danger');
            });
    }

    // 地點搜尋
    function searchByLocation() {
        const location = document.getElementById('locationSearch').value;
        if (!location) {
            showAlert('請輸入搜尋地點', 'warning');
            return;
        }

        fetch(`/api/accommodations/search?location=${encodeURIComponent(location)}`)
            .then(response => response.json())
            .then(data => displayAccommodations(data))
            .catch(error => {
                console.error('Error:', error);
                showAlert('搜尋失敗', 'danger');
            });
    }

    // 查詢可用住宿
    function searchAvailable() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;

        if (!checkIn || !checkOut) {
            showAlert('請選擇入住和退房日期', 'warning');
            return;
        }

        if (checkIn >= checkOut) {
            showAlert('入住日期必須早於退房日期', 'warning');
            return;
        }

        fetch(`/api/accommodations/available?checkIn=${checkIn}&checkOut=${checkOut}`)
            .then(response => response.json())
            .then(data => displayAccommodations(data))
            .catch(error => {
                console.error('Error:', error);
                showAlert('查詢失敗', 'danger');
            });
    }

    // 顯示住宿列表
    function displayAccommodations(accommodations) {
        const container = document.getElementById('accommodations');

        if (accommodations.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">沒有找到符合條件的住宿</div></div>';
            return;
        }

        container.innerHTML = accommodations.map(acc => `
        <div class="col-md-4 mb-3">
            <div class="card accommodation-card h-100">
                <div class="card-body">
                    <h5 class="card-title">${acc.name}</h5>
                    <p class="card-text">
                        <strong>地點:</strong> ${acc.location}<br>
                        <strong>描述:</strong> ${acc.description}<br>
                        <strong class="text-success">每晚 NT$ ${acc.pricePerNight || '0'}</strong>
                    </p>
                    <button class="btn btn-primary" onclick="openBookingModal(${acc.id}, '${acc.name}', '${acc.location}', ${acc.pricePerNight || 0})">
                        立即預訂
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    }

    // 開啟訂房模態框
    function openBookingModal(accommodationId, name, location, pricePerNight) {
        selectedAccommodationId = accommodationId;
        selectedPricePerNight = pricePerNight; // 儲存價格

        document.getElementById('bookingDetails').innerHTML = `
        <h6>住宿資訊</h6>
        <p><strong>名稱:</strong> ${name}</p>
        <p><strong>地點:</strong> ${location}</p>
        <p><strong>每晚價格:</strong> <span class="text-success">NT$ ${pricePerNight}</span></p>
        <p><strong>預估總價:</strong> <span id="estimatedTotal" class="text-primary fw-bold">請選擇日期</span></p>
    `;

        // 預設填入搜尋的日期
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        document.getElementById('modalCheckIn').value = checkIn;
        document.getElementById('modalCheckOut').value = checkOut;

        // 計算初始總價
        updateEstimatedTotal();

        // 為日期輸入框添加事件監聽器
        document.getElementById('modalCheckIn').addEventListener('change', updateEstimatedTotal);
        document.getElementById('modalCheckOut').addEventListener('change', updateEstimatedTotal);

        bookingModal.show();
    }

    let selectedPricePerNight = 0;

    function updateEstimatedTotal() {
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;

        if (checkIn && checkOut && checkIn < checkOut) {
            const nights = calculateDays(checkIn, checkOut);
            const total = selectedPricePerNight * nights;
            document.getElementById('estimatedTotal').textContent = `NT$ ${total.toLocaleString()} (${nights} 晚)`;
        } else {
            document.getElementById('estimatedTotal').textContent = '請選擇有效日期';
        }
    }


    // 確認訂房
    function confirmBooking() {
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;

        if (!checkIn || !checkOut) {
            showAlert('請選擇入住和退房日期', 'warning');
            return;
        }

        if (checkIn >= checkOut) {
            showAlert('入住日期必須早於退房日期', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('accommodationId', selectedAccommodationId);
        formData.append('checkIn', checkIn);
        formData.append('checkOut', checkOut);

        fetch('/api/bookings', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('訂房失敗');
                }
            })
            .then(data => {
                bookingModal.hide();
                showAlert('訂房成功！', 'success');
                loadMyBookings();
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert(error.message || '訂房失敗', 'danger');
            });
    }

    // 載入我的訂房記錄
    function loadMyBookings() {
        fetch('/api/bookings')
            .then(response => response.json())
            .then(data => displayMyBookings(data))
            .catch(error => {
                console.error('Error:', error);
                showAlert('載入訂房記錄失敗', 'danger');
            });
    }

    // 顯示我的訂房記錄
    function displayMyBookings(bookings) {
        const container = document.getElementById('myBookings');

        if (bookings.length === 0) {
            container.innerHTML = '<div class="alert alert-info">您還沒有任何訂房記錄</div>';
            return;
        }

        container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>訂房編號</th>
                        <th>住宿名稱</th>
                        <th>地點</th>
                        <th>入住日期</th>
                        <th>退房日期</th>
                        <th>天數</th>
                        <th>總費用</th>
                    </tr>
                </thead>
                <tbody>
                    ${bookings.map(booking => `
                        <tr>
                            <td>${booking.id}</td>
                            <td>${booking.accommodation.name}</td>
                            <td>${booking.accommodation.location}</td>
                            <td>${booking.checkIn}</td>
                            <td>${booking.checkOut}</td>
                            <td>${calculateDays(booking.checkIn, booking.checkOut)}</td>
                            <td class="text-success fw-bold">NT$ ${booking.totalPrice ? Number(booking.totalPrice).toLocaleString() : '計算中'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    }


    // 計算住宿天數
    function calculateDays(checkIn, checkOut) {
        const start = new Date(checkIn);
        const end = new Date(checkOut);
        const diffTime = Math.abs(end - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // 顯示警示訊息
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        // 找到容器並插入到最前面
        const container = document.querySelector('.container');
        const firstChild = container.firstElementChild;
        container.insertBefore(alertDiv, firstChild);

        // 5秒後自動移除
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

</script>
</body>
</html>